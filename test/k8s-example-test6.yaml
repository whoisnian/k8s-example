apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: init-node
spec:
  selector:
    matchLabels:
      k8s-example: init-node
  template:
    metadata:
      labels:
        k8s-example: init-node
    spec:
      initContainers:
        - name: sleep-20
          image: reg.whoisnian.com/proxy.docker.io/library/alpine:3.15
          command: ["sh", "-c", "sleep 20"]
      containers:
        - name: pong
          image: reg.whoisnian.com/k8s-example/k8s-example-test:v0.0.5
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  labels:
    k8s-example: init-node-svc
  name: init-node-svc
spec:
  internalTrafficPolicy: Local
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    k8s-example: init-node
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: init-public
spec:
  selector:
    matchLabels:
      k8s-example: init-public
  template:
    metadata:
      labels:
        k8s-example: init-public
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: k8s-example
                    operator: In
                    values: ["init-node"]
              topologyKey: kubernetes.io/hostname
      initContainers:
        - name: ping
          image: reg.whoisnian.com/proxy.docker.io/library/alpine:3.15
          command:
            [
              "sh",
              "-c",
              "for i in $(seq 1 10); do sleep 3; if wget -O- init-node-svc:8080/ping; then exit 0; fi; done; exit 1",
            ]
        - name: sleep-20
          image: reg.whoisnian.com/proxy.docker.io/library/alpine:3.15
          command: ["sh", "-c", "sleep 20"]
      containers:
        - name: noop
          image: reg.whoisnian.com/k8s-example/k8s-example-test:v0.0.5
          command: ["sh", "-c", "trap : TERM INT; sleep infinity & wait"]
